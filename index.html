<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Shooter Táctico: Fuego Amigo</title>
    <style>
        body {
            background-color: #0d0d0d;
            color: #eee;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
            background-color: #1a1a1a;
            cursor: crosshair;
        }
        .ui-layer {
            position: absolute;
            top: 20px; left: 50%;
            transform: translateX(-50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.85);
            padding: 10px 20px;
            border-radius: 12px;
            border: 1px solid #444;
            pointer-events: none;
            display: none;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 4px;
            background: #333;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 1.2em;
        }
        #mainMenu {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.95);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 10;
        }
        h1 { font-size: 3em; margin-bottom: 10px; color: #4CAF50; text-shadow: 0 0 20px #4CAF50; }
        .level-btn {
            background: #222; color: white;
            border: 2px solid #444; padding: 15px 40px;
            margin: 10px; font-size: 1.5em; cursor: pointer;
            width: 300px; transition: 0.2s;
            font-family: inherit;
        }
        .level-btn:hover { background: #444; border-color: #fff; transform: scale(1.05); }
        #backBtn {
            position: absolute; top: 20px; right: 20px;
            background: #d32f2f; color: white; border: none;
            padding: 10px 15px; cursor: pointer; font-family: inherit;
            border-radius: 5px; display: none; pointer-events: auto;
        }
        #backBtn:hover { background: #b71c1c; }
    </style>
</head>
<body>

    <div id="mainMenu">
        <h1>ONE BULLET</h1>
        <p style="color: #aaa; margin-bottom: 20px;">Cuidado: Tu propia bala te mata si rebota.</p>
        <button class="level-btn" onclick="loadLevel(1)">NIVEL 1</button>
        <div style="color: #888; margin-bottom: 20px;">Entrenamiento</div>
        <button class="level-btn" onclick="loadLevel(2)" style="border-color: #FF5722; color: #FFCCBC;">NIVEL 2</button>
        <div style="color:#FF5722">El Bunker (Difícil)</div>
    </div>

    <div class="ui-layer" id="gameUI">
        <div class="status-badge" id="statusText">ZONA SEGURA</div>
        <div style="font-size: 0.8em; color: #aaa;">
            WASD: Mover | CLICK: Disparar<br>
            <strong style="color: #FFEB3B">REGLA: Solo recoge la bala cuando se detenga.</strong>
        </div>
    </div>

    <button id="backBtn" onclick="showMenu()">SALIR</button>
    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const uiLayer = document.getElementById('gameUI');
    const mainMenu = document.getElementById('mainMenu');
    const backBtn = document.getElementById('backBtn');
    const statusText = document.getElementById('statusText');

    const WORLD_WIDTH = 2500;
    const WORLD_HEIGHT = 2000;

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let gameState = { active: false, gameOver: false };
    let camera = { x: 0, y: 0 };
    let walls = [], enemies = [], enemyBullets = [];

    // --- NIVELES ---

    function getLevel1() {
        return {
            playerStart: { x: 200, y: 200 },
            walls: [
                { x: -50, y: -50, w: WORLD_WIDTH+100, h: 50 }, { x: -50, y: WORLD_HEIGHT, w: WORLD_WIDTH+100, h: 50 },
                { x: -50, y: 0, w: 50, h: WORLD_HEIGHT }, { x: WORLD_WIDTH, y: 0, w: 50, h: WORLD_HEIGHT },
                { x: 400, y: 100, w: 20, h: 500 }, { x: 0, y: 600, w: 300, h: 20 },
                { x: 600, y: 200, w: 20, h: 800 }, { x: 800, y: 200, w: 20, h: 800 },
                { x: 1000, y: 400, w: 400, h: 20 }, { x: 1400, y: 200, w: 20, h: 600 },
                { x: 200, y: 1200, w: 1000, h: 20 }, { x: 1600, y: 1000, w: 20, h: 800 }
            ],
            enemies: [
                { x: 500, y: 300, w: 32, h: 32, color: '#D32F2F', type: 'normal', alive: true, cd: 0 },
                { x: 1200, y: 300, w: 32, h: 32, color: '#D32F2F', type: 'normal', alive: true, cd: 0 },
                { x: 700, y: 500, w: 32, h: 32, color: '#FF5722', type: 'shotgun', alive: true, cd: 0 },
                { x: 300, y: 1400, w: 32, h: 32, color: '#D32F2F', type: 'normal', alive: true, cd: 0 },
                { x: 1100, y: 1500, w: 32, h: 32, color: '#D32F2F', type: 'normal', alive: true, cd: 0 }
            ]
        };
    }

    function getLevel2() {
        return {
            playerStart: { x: 100, y: 100 },
            walls: [
                // Bordes externos
                { x: -50, y: -50, w: WORLD_WIDTH+100, h: 50 }, { x: -50, y: WORLD_HEIGHT, w: WORLD_WIDTH+100, h: 50 },
                { x: -50, y: 0, w: 50, h: WORLD_HEIGHT }, { x: WORLD_WIDTH, y: 0, w: 50, h: WORLD_HEIGHT },
                
                // HABITACIÓN INICIAL (Modificada con puerta)
                { x: 300, y: 0, w: 20, h: 150 },   // Parte arriba puerta
                { x: 300, y: 250, w: 20, h: 150 }, // Parte abajo puerta (hueco de 100px)
                { x: 0, y: 400, w: 300, h: 20 },
                
                // Resto del nivel
                { x: 300, y: 400, w: 600, h: 200 }, 
                { x: 1000, y: 100, w: 20, h: 800 }, 
                { x: 1000, y: 900, w: 500, h: 20 }, 
                { x: 100, y: 800, w: 20, h: 800 }, 
                { x: 120, y: 1200, w: 400, h: 20 }, 
                { x: 600, y: 800, w: 20, h: 600 }, 
                { x: 1600, y: 0, w: 200, h: 600 }, 
                { x: 1600, y: 800, w: 20, h: 1000 }, 
                { x: 2000, y: 1000, w: 400, h: 20 }, 
                { x: 2200, y: 1200, w: 20, h: 600 }
            ],
            enemies: [
                { x: 500, y: 200, w: 32, h: 32, color: '#FF5722', type: 'shotgun', alive: true, cd: 0 },
                { x: 800, y: 100, w: 32, h: 32, color: '#FF5722', type: 'shotgun', alive: true, cd: 0 },
                { x: 200, y: 1000, w: 32, h: 32, color: '#D32F2F', type: 'normal', alive: true, cd: 0 },
                { x: 400, y: 1400, w: 32, h: 32, color: '#FF5722', type: 'shotgun', alive: true, cd: 0 },
                { x: 1200, y: 500, w: 32, h: 32, color: '#D32F2F', type: 'normal', alive: true, cd: 0 },
                { x: 1400, y: 700, w: 32, h: 32, color: '#D32F2F', type: 'normal', alive: true, cd: 0 },
                { x: 1800, y: 1200, w: 32, h: 32, color: '#FF5722', type: 'shotgun', alive: true, cd: 0 },
                { x: 2300, y: 1700, w: 32, h: 32, color: '#FF5722', type: 'shotgun', alive: true, cd: 0 }
            ]
        };
    }

    // --- OBJETOS DE JUEGO ---

    const keys = { w: false, a: false, s: false, d: false };
    const mouseScreen = { x: 0, y: 0 };
    const mouseWorld = { x: 0, y: 0 };

    document.addEventListener('keydown', (e) => { if(keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()] = true; });
    document.addEventListener('keyup', (e) => { if(keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()] = false; });
    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        mouseScreen.x = e.clientX - rect.left; mouseScreen.y = e.clientY - rect.top;
    });
    canvas.addEventListener('mousedown', (e) => { if (gameState.active && e.button === 0) tryShoot(); });

    const player = {
        x: 0, y: 0, radius: 15, speed: 4, color: '#4CAF50', hasBullet: true,
        update() {
            if (gameState.gameOver || !gameState.active) return;
            let dx = 0, dy = 0;
            if (keys.w) dy -= this.speed; if (keys.s) dy += this.speed;
            if (keys.a) dx -= this.speed; if (keys.d) dx += this.speed;
            if (dx && dy) { dx *= 0.707; dy *= 0.707; }
            if (!checkWallCollision(this.x + dx, this.y, this.radius)) this.x += dx;
            if (!checkWallCollision(this.x, this.y + dy, this.radius)) this.y += dy;
            this.x = Math.max(this.radius, Math.min(WORLD_WIDTH - this.radius, this.x));
            this.y = Math.max(this.radius, Math.min(WORLD_HEIGHT - this.radius, this.y));
            mouseWorld.x = mouseScreen.x + camera.x; mouseWorld.y = mouseScreen.y + camera.y;
        },
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            ctx.beginPath(); ctx.arc(0,0,this.radius,0,Math.PI*2); ctx.fillStyle=this.color; ctx.fill();
            ctx.strokeStyle='#2E7D32'; ctx.lineWidth=2; ctx.stroke();
            ctx.rotate(Math.atan2(mouseWorld.y-this.y, mouseWorld.x-this.x));
            ctx.fillStyle='#111'; ctx.fillRect(0,-4,28,8);
            ctx.restore();
            if(this.hasBullet) { ctx.beginPath(); ctx.arc(this.x,this.y-25,4,0,Math.PI*2); ctx.fillStyle='#FFEB3B'; ctx.fill(); }
        }
    };

    const playerBullet = {
        x:0, y:0, radius:5, speed:12, dx:0, dy:0, active:false, isMoving:false, cooldown:0, bounceCount:0, maxBounces:3,
        fire(sx,sy,tx,ty){
            this.x=sx; this.y=sy; this.active=true; this.isMoving=true; this.cooldown=10; this.bounceCount=0;
            const a = Math.atan2(ty-sy, tx-sx); this.dx=Math.cos(a)*this.speed; this.dy=Math.sin(a)*this.speed;
            updateStatus("BALA EN EL AIRE", "#E65100");
        },
        stop(){ this.dx=0; this.dy=0; this.isMoving=false; updateStatus("BALA DETENIDA - RECOGER", "#999"); },
        update(){
            if(!this.active) return;
            if(this.cooldown>0) this.cooldown--; // Tiempo de gracia al salir del cañón

            // INTERACCIÓN CON EL JUGADOR (MECÁNICA NUEVA)
            if(this.cooldown === 0) {
                const dist = Math.hypot(this.x-player.x, this.y-player.y);
                if(dist < player.radius + this.radius + 5) {
                    if (this.isMoving) {
                        // SI SE MUEVE: MUERTE
                        triggerGameOver("TE DISPARASTE TÚ MISMO");
                    } else {
                        // SI ESTÁ QUIETA: RECOGER
                        this.active=false; player.hasBullet=true; updateStatus("LISTO", "#4CAF50"); return;
                    }
                }
            }

            if(!this.isMoving) return;

            let nx=this.x+this.dx, ny=this.y+this.dy, bounced=false;
            if(checkWallCollision(nx, this.y, this.radius)){ this.dx*=-1; bounced=true; } else this.x+=this.dx;
            if(checkWallCollision(this.x, ny, this.radius)){ this.dy*=-1; bounced=true; } else this.y+=this.dy;
            if(this.x<0||this.x>WORLD_WIDTH){ this.dx*=-1; bounced=true; }
            if(this.y<0||this.y>WORLD_HEIGHT){ this.dy*=-1; bounced=true; }
            if(bounced){ this.bounceCount++; if(this.bounceCount>=this.maxBounces) this.stop(); }
        },
        draw(){
            if(!this.active) return;
            ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
            // Amarillo si es peligrosa (se mueve), Gris si es segura (quieta)
            ctx.fillStyle = this.isMoving ? '#FFEB3B' : '#757575'; 
            ctx.fill();
            if(this.isMoving) { ctx.shadowBlur=10; ctx.shadowColor='#FFEB3B'; }
            ctx.shadowBlur=0;
        }
    };

    class EnemyBullet {
        constructor(x, y, angle, speedMult=1.0) {
            this.x=x; this.y=y; this.speed=7*speedMult; this.radius = speedMult<1?3.5:4;
            this.dx=Math.cos(angle)*this.speed; this.dy=Math.sin(angle)*this.speed; this.del=false;
        }
        update(){
            this.x+=this.dx; this.y+=this.dy;
            if(checkWallCollision(this.x,this.y,this.radius)||this.x<0||this.x>WORLD_WIDTH||this.y<0||this.y>WORLD_HEIGHT) this.del=true;
            if(Math.hypot(this.x-player.x, this.y-player.y)<this.radius+player.radius) triggerGameOver("TE ALCANZARON");
        }
        draw(){ ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2); ctx.fillStyle='#ff3333'; ctx.fill(); }
    }

    function showMenu() { gameState.active = false; mainMenu.style.display = 'flex'; uiLayer.style.display = 'none'; backBtn.style.display = 'none'; }
    let currentLevelId = 1;

    function loadLevel(levelId) {
        currentLevelId = levelId;
        const data = (levelId === 1) ? getLevel1() : getLevel2();
        walls = data.walls;
        enemies = data.enemies.map(e => ({...e}));
        player.x = data.playerStart.x; player.y = data.playerStart.y;
        player.hasBullet = true; playerBullet.active = false; enemyBullets = [];
        gameState.gameOver = false; gameState.active = true;
        mainMenu.style.display = 'none'; uiLayer.style.display = 'block'; backBtn.style.display = 'block';
        updateStatus("ZONA SEGURA", "#333");
    }

    function restartLevel() { loadLevel(currentLevelId); }
    function updateStatus(text, bg) { statusText.innerText = text; statusText.style.background = bg; }
    function triggerGameOver(msg) { if(gameState.gameOver) return; gameState.gameOver = true; updateStatus(msg + " - CLICK PARA REINICIAR", "#000"); }
    function tryShoot() { if(gameState.gameOver) { restartLevel(); return; } if(player.hasBullet) { player.hasBullet = false; playerBullet.fire(player.x, player.y, mouseWorld.x, mouseWorld.y); } }
    function checkWallCollision(cx, cy, radius) {
        for(let w of walls) {
            let tx = Math.max(w.x, Math.min(cx, w.x+w.w)); let ty = Math.max(w.y, Math.min(cy, w.y+w.h));
            if(Math.hypot(cx-tx, cy-ty) <= radius) return true;
        } return false;
    }

    function loop() {
        if(gameState.active && !gameState.gameOver) {
            player.update();
            camera.x = Math.max(0, Math.min(player.x - canvas.width/2, WORLD_WIDTH - canvas.width));
            camera.y = Math.max(0, Math.min(player.y - canvas.height/2, WORLD_HEIGHT - canvas.height));
            playerBullet.update();

            enemies.forEach(e => {
                if(!e.alive) return;
                if(e.cd>0) e.cd--;
                const dist = Math.hypot(player.x - e.x, player.y - e.y);
                if(dist < 550 && e.cd <= 0) {
                     const angle = Math.atan2(player.y - e.y, player.x - e.x);
                     if(e.type === 'normal') {
                         enemyBullets.push(new EnemyBullet(e.x+16, e.y+16, angle));
                         e.cd = 90 + Math.random()*60;
                     } else {
                         for(let i=-2; i<=2; i++) {
                             enemyBullets.push(new EnemyBullet(e.x+16, e.y+16, angle + i*0.15, 0.8 + Math.random()*0.2));
                         } e.cd = 160 + Math.random()*60;
                     }
                }
            });

            enemyBullets.forEach(b => b.update());
            enemyBullets = enemyBullets.filter(b => !b.del);

            if(playerBullet.active && playerBullet.isMoving) {
                enemies.forEach(e => {
                    if(e.alive) {
                        let tx = Math.max(e.x, Math.min(playerBullet.x, e.x+e.w));
                        let ty = Math.max(e.y, Math.min(playerBullet.y, e.y+e.h));
                        if(Math.hypot(playerBullet.x-tx, playerBullet.y-ty) <= playerBullet.radius) {
                            e.alive = false; playerBullet.stop(); 
                            playerBullet.x = e.x+16; playerBullet.y = e.y+16;
                        }
                    }
                });
            }
            enemies.forEach(e => {
                if(e.alive) {
                    let tx = Math.max(e.x, Math.min(player.x, e.x+e.w));
                    let ty = Math.max(e.y, Math.min(player.y, e.y+e.h));
                    if(Math.hypot(player.x-tx, player.y-ty) <= player.radius) triggerGameOver("CONTACTO MORTAL");
                }
            });
        }

        ctx.fillStyle = '#0d0d0d'; ctx.fillRect(0,0,canvas.width,canvas.height);
        
        if (gameState.active) {
            ctx.save(); ctx.translate(-camera.x, -camera.y);
            ctx.strokeStyle='#1a1a1a'; ctx.lineWidth=2; ctx.beginPath();
            for(let x=0;x<=WORLD_WIDTH;x+=100){ctx.moveTo(x,0);ctx.lineTo(x,WORLD_HEIGHT);}
            for(let y=0;y<=WORLD_HEIGHT;y+=100){ctx.moveTo(0,y);ctx.lineTo(WORLD_WIDTH,y);} ctx.stroke();
            ctx.fillStyle='#444'; ctx.strokeStyle='#555'; ctx.lineWidth=1;
            for(let w of walls){ ctx.fillRect(w.x,w.y,w.w,w.h); ctx.strokeRect(w.x,w.y,w.w,w.h); }
            for(let e of enemies){
                if(e.alive){
                    ctx.fillStyle=e.color; ctx.fillRect(e.x,e.y,e.w,e.h);
                    ctx.fillStyle='#000'; ctx.fillRect(e.x+8,e.y+8,4,4); ctx.fillRect(e.x+20,e.y+8,4,4);
                }
            }
            enemyBullets.forEach(b => b.draw());
            playerBullet.draw();
            player.draw();
            ctx.restore();

            if(gameState.gameOver) {
                ctx.fillStyle='rgba(50,0,0,0.7)'; ctx.fillRect(0,0,canvas.width,canvas.height);
                ctx.fillStyle='#fff'; ctx.font='bold 40px Courier New'; ctx.textAlign='center';
                ctx.fillText(statusText.innerText.split('-')[0], canvas.width/2, canvas.height/2);
                ctx.font='20px Courier New'; ctx.fillText('Click para reiniciar', canvas.width/2, canvas.height/2+40);
            }
        } else {
            ctx.fillStyle = '#111'; ctx.fillRect(0,0,canvas.width, canvas.height);
        }
        requestAnimationFrame(loop);
    }
    showMenu(); loop();
</script>
</body>
</html>